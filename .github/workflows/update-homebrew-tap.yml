name: Update Homebrew Tap

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  update-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        
      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: JAManfredi/homebrew-cascade-cli
          path: homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
      
      - name: Download and compute checksums
        run: |
          VERSION=${{ github.event.inputs.version }}
          cd cascade-cli
          
          # Download macOS binaries
          curl -L -o ca-macos-arm64.tar.gz \
            "https://github.com/JAManfredi/cascade-cli/releases/download/v${VERSION}/ca-macos-arm64.tar.gz"
          curl -L -o ca-macos-x64.tar.gz \
            "https://github.com/JAManfredi/cascade-cli/releases/download/v${VERSION}/ca-macos-x64.tar.gz"
          
          # Compute checksums
          ARM64_SHA=$(shasum -a 256 ca-macos-arm64.tar.gz | cut -d' ' -f1)
          X64_SHA=$(shasum -a 256 ca-macos-x64.tar.gz | cut -d' ' -f1)
          
          echo "ARM64_SHA=$ARM64_SHA" >> $GITHUB_ENV
          echo "X64_SHA=$X64_SHA" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Update formula version
        run: |
          # Get version from release or input
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          
          echo "Updating formula to version $VERSION"
          
          # Update the formula
          cd homebrew-tap
          
          # Update URLs
          sed -i "s|https://github.com/JAManfredi/cascade-cli/releases/download/v[^/]*/ca-macos-arm64.tar.gz|https://github.com/JAManfredi/cascade-cli/releases/download/v${VERSION}/ca-macos-arm64.tar.gz|g" Formula/cascade-cli.rb
          sed -i "s|https://github.com/JAManfredi/cascade-cli/releases/download/v[^/]*/ca-macos-x64.tar.gz|https://github.com/JAManfredi/cascade-cli/releases/download/v${VERSION}/ca-macos-x64.tar.gz|g" Formula/cascade-cli.rb
          
          # Update version
          sed -i "s/version \"v[^\"]*\"/version \"v${VERSION}\"/g" Formula/cascade-cli.rb
          
          # Update checksums
          sed -i "s/sha256 \"[a-f0-9]*\" # ARM64/sha256 \"${ARM64_SHA}\" # ARM64/g" Formula/cascade-cli.rb  
          sed -i "s/sha256 \"[a-f0-9]*\" # x64/sha256 \"${X64_SHA}\" # x64/g" Formula/cascade-cli.rb
          
      - name: Commit and push changes
        run: |
          cd homebrew-tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          VERSION="${{ github.event.release.tag_name || github.event.inputs.version }}"
          git add Formula/cascade-cli.rb
          git commit -m "Update Cascade CLI to ${VERSION}"
          git push
      
      - name: Test formula
        run: |
          # Simple syntax check
          cd homebrew-tap
          ruby -c Formula/cascade-cli.rb

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          path: cascade-cli
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update Homebrew formula to v${{ github.event.inputs.version }}"
          title: "Update Homebrew formula to v${{ github.event.inputs.version }}"
          body: |
            Updates Homebrew formula for Cascade CLI v${{ github.event.inputs.version }}
            
            Changes:
            - Updated download URLs to point to v${{ github.event.inputs.version }} release
            - Updated SHA256 checksums for macOS binaries
            - Updated version number to v${{ github.event.inputs.version }}
            
            This PR was auto-generated by the update-homebrew-tap workflow.
          branch: update-homebrew-v${{ github.event.inputs.version }}
          delete-branch: true